<!DOCTYPE html>
<html lang="en"><head>
    <title>Greg&#39;s Blog</title>
    <meta content="text/html;charset=utf-8" http-equiv="Content-Type">
    <meta content="utf-8" http-equiv="encoding">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="format-detection" content="telephone=no" />
    <meta name="theme-color" content="#000084" />
    <link rel="icon" href="https://win32.gg/favicon.ico">
    <link rel="canonical" href="https://win32.gg">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.css">
<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/katex.min.js"></script>

<script defer src="https://cdn.jsdelivr.net/npm/katex@0.12.0/dist/contrib/auto-render.min.js" onload="renderMathInElement(document.body);"></script>

    <script>
        document.addEventListener("DOMContentLoaded", function() {
            renderMathInElement(document.body, {
                delimiters: [
                    {left: "$$", right: "$$", display: true},
                    {left: "$", right: "$", display: false}
                ]
            });
        });
    </script>
    
    
    <link rel="stylesheet" href="/css/bootstrap.css">
    <link rel="stylesheet" href="/css/bootstrap-responsive.css">
    <link rel="stylesheet" href="/css/style.css">
    
</head>
<body>
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-inner">
        <div class="container">
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse"></button>
            <a class="brand" href="https://win32.gg">Greg&#39;s Blog</a>
            <div class="nav-collapse collapse">
                <ul class="nav">
                    
                    
                        
                            <li>
                                <a href="/posts/">
                                    
                                    <span>All posts</span>
                                </a>
                            </li>
                        
                    
                </ul>
            </div>
        </div>
    </div>
</nav><div id="content" class="container">

<div class="row-fluid navmargin">
    <div class="page-header">
        <h1>Openvpn Manager - Sun, Jul 10, 2022</h1>
    </div>
    <p class="lead">An open source web app to add users and monitor an OpenVPN instance</p>
    <h1 id="what-to-do">What to do</h1>
<p>OpenVPN is an open-source VPN software commonly used in universities, workplaces or even homelabs. I always liked using it and it actually taught me a lot regarding certificates (it used to be shipped with easy-rsa), networking, routing etc&hellip; At the time I started to need to use it at scale for my lab I couldn&rsquo;t find any tool with a web interface. I seems everybody just loved to make their own script to add new users and well&hellip; so did I.</p>
<p>Still, I wanted something web based so I could eventually delegate the task of adding new users to personnel unfamiliar with a command line. Additionally, I wanted a small project to start learning vue and &ldquo;modern&rdquo; web and thought it was the perfect project to get started.</p>
<p>The project&rsquo;s outline is easy enough, have an OpenVPN instance, build an API around that, make a front end connecting to that API:</p>



<div class="goat svg-container ">
  
    <svg
      xmlns="http://www.w3.org/2000/svg"
      font-family="Menlo,Lucida Console,monospace"
      
        viewBox="0 0 1056 89"
      >
      <g transform='translate(8,16)'>
<text text-anchor='middle' x='0' y='4' fill='currentColor' style='font-size:1em'>┌</text>
<text text-anchor='middle' x='0' y='20' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='0' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='0' y='52' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='0' y='68' fill='currentColor' style='font-size:1em'>└</text>
<text text-anchor='middle' x='8' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='8' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='16' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='16' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='24' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='24' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='32' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='32' y='36' fill='currentColor' style='font-size:1em'>O</text>
<text text-anchor='middle' x='32' y='52' fill='currentColor' style='font-size:1em'>R</text>
<text text-anchor='middle' x='32' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='40' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='40' y='36' fill='currentColor' style='font-size:1em'>p</text>
<text text-anchor='middle' x='40' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='40' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='48' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='48' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='48' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='48' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='56' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='56' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='56' y='52' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='56' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='64' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='64' y='36' fill='currentColor' style='font-size:1em'>V</text>
<text text-anchor='middle' x='64' y='52' fill='currentColor' style='font-size:1em'>u</text>
<text text-anchor='middle' x='64' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='72' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='72' y='36' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='72' y='52' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='72' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='80' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='80' y='36' fill='currentColor' style='font-size:1em'>N</text>
<text text-anchor='middle' x='80' y='52' fill='currentColor' style='font-size:1em'>c</text>
<text text-anchor='middle' x='80' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='88' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='88' y='52' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='88' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='96' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='96' y='52' fill='currentColor' style='font-size:1em'>s</text>
<text text-anchor='middle' x='96' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='104' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='104' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='112' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='112' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='120' y='4' fill='currentColor' style='font-size:1em'>┐</text>
<text text-anchor='middle' x='120' y='20' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='120' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='120' y='52' fill='currentColor' style='font-size:1em'>├</text>
<text text-anchor='middle' x='120' y='68' fill='currentColor' style='font-size:1em'>┘</text>
<text text-anchor='middle' x='128' y='20' fill='currentColor' style='font-size:1em'>◄</text>
<text text-anchor='middle' x='128' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='136' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='136' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='144' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='144' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='152' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='152' y='52' fill='currentColor' style='font-size:1em'>►</text>
<text text-anchor='middle' x='160' y='4' fill='currentColor' style='font-size:1em'>┌</text>
<text text-anchor='middle' x='160' y='20' fill='currentColor' style='font-size:1em'>┤</text>
<text text-anchor='middle' x='160' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='160' y='52' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='160' y='68' fill='currentColor' style='font-size:1em'>└</text>
<text text-anchor='middle' x='168' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='168' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='176' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='176' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='184' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='184' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='192' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='192' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='200' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='200' y='36' fill='currentColor' style='font-size:1em'>A</text>
<text text-anchor='middle' x='200' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='208' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='208' y='36' fill='currentColor' style='font-size:1em'>P</text>
<text text-anchor='middle' x='208' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='216' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='216' y='36' fill='currentColor' style='font-size:1em'>I</text>
<text text-anchor='middle' x='216' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='224' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='224' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='232' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='232' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='240' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='240' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='248' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='248' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='256' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='256' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='264' y='4' fill='currentColor' style='font-size:1em'>┐</text>
<text text-anchor='middle' x='264' y='20' fill='currentColor' style='font-size:1em'>├</text>
<text text-anchor='middle' x='264' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='264' y='52' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='264' y='68' fill='currentColor' style='font-size:1em'>┘</text>
<text text-anchor='middle' x='272' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='272' y='52' fill='currentColor' style='font-size:1em'>◄</text>
<text text-anchor='middle' x='280' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='280' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='288' y='20' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='288' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='296' y='20' fill='currentColor' style='font-size:1em'>►</text>
<text text-anchor='middle' x='296' y='52' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='304' y='4' fill='currentColor' style='font-size:1em'>┌</text>
<text text-anchor='middle' x='304' y='20' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='304' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='304' y='52' fill='currentColor' style='font-size:1em'>┤</text>
<text text-anchor='middle' x='304' y='68' fill='currentColor' style='font-size:1em'>└</text>
<text text-anchor='middle' x='312' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='312' y='36' fill='currentColor' style='font-size:1em'>F</text>
<text text-anchor='middle' x='312' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='320' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='320' y='36' fill='currentColor' style='font-size:1em'>r</text>
<text text-anchor='middle' x='320' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='328' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='328' y='36' fill='currentColor' style='font-size:1em'>o</text>
<text text-anchor='middle' x='328' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='336' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='336' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='336' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='344' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='344' y='36' fill='currentColor' style='font-size:1em'>t</text>
<text text-anchor='middle' x='344' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='352' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='352' y='36' fill='currentColor' style='font-size:1em'>-</text>
<text text-anchor='middle' x='352' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='360' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='360' y='36' fill='currentColor' style='font-size:1em'>e</text>
<text text-anchor='middle' x='360' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='368' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='368' y='36' fill='currentColor' style='font-size:1em'>n</text>
<text text-anchor='middle' x='368' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='376' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='376' y='36' fill='currentColor' style='font-size:1em'>d</text>
<text text-anchor='middle' x='376' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='384' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='384' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='392' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='392' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='400' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='400' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='408' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='408' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='416' y='4' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='416' y='68' fill='currentColor' style='font-size:1em'>─</text>
<text text-anchor='middle' x='424' y='4' fill='currentColor' style='font-size:1em'>┐</text>
<text text-anchor='middle' x='424' y='20' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='424' y='36' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='424' y='52' fill='currentColor' style='font-size:1em'>│</text>
<text text-anchor='middle' x='424' y='68' fill='currentColor' style='font-size:1em'>┘</text>
</g>

    </svg>
  
</div>
<p>The project is available <a href="https://dvic.devinci.fr/gitlab/server/vpn-manager">here</a></p>
<h1 id="building-the-api">Building the API</h1>
<p>Having an API is standard for this sort of project and really is the best way to have a hassle-free front-end implementation. Vue projects connecting to a REST API of some sort are legion and its best for a first project.</p>
<h3 id="interacting-with-openvpn">Interacting with OpenVPN</h3>
<p>First off we need to interact with OpenVPN, that means getting data from the server and pushing data such as users to it.</p>
<h4 id="pulling">Pulling</h4>
<p>Thankfully, OpenVPN does have an easy way of providing data. The server config file allows for a <code>status</code> directive to provide an automatically updated file with server status and connected client information information.</p>
<pre tabindex="0"><code>status openvpn-status.log
</code></pre><p>The status file found at <code>/etc/openvpn/openpvpn-status.log</code> has the format:</p>
<pre tabindex="0"><code>OpenVPN CLIENT LIST
Updated,Fri May 20 11:01:20 2022
Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since
&lt;REDACTED_NAME&gt;,&lt;REDACTED_IP&gt;:9363,1682579,1602370,Mon May 16 14:17:36 2022
ROUTING TABLE
Virtual Address,Common Name,Real Address,Last Ref
10.8.0.10,&lt;REDACTED_NAME&gt;,&lt;REDACTED_IP&gt;:53516,Fri May 20 11:01:19 2022
GLOBAL STATS
Max bcast/mcast queue length,59
END
</code></pre><p>So we can parse that easily and update the status of the VPN accordingly. The file is updated automatically by openvpn every 30 seconds approximately.
The parsing is done simply with in the api:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">get_status</span>():
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(OPENVPN_STATUS_FILE, <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> fh:
</span></span><span style="display:flex;"><span>        fh<span style="color:#f92672">.</span>readline() <span style="color:#75715e"># Skip &#34;OpenVPN CLIENT LIST&#34;</span>
</span></span><span style="display:flex;"><span>        last_updated <span style="color:#f92672">=</span> fh<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#75715e"># Updated, date</span>
</span></span><span style="display:flex;"><span>        fh<span style="color:#f92672">.</span>readline() <span style="color:#75715e">#Skip header Common Name,Real Address,Bytes Received,Bytes Sent,Connected Since</span>
</span></span><span style="display:flex;"><span>        clients <span style="color:#f92672">=</span> {}
</span></span><span style="display:flex;"><span>        addr <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Clients</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            cmp <span style="color:#f92672">=</span> fh<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(cmp) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">5</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            clients[cmp[<span style="color:#ae81ff">1</span>]] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;name&#39;</span>: cmp[<span style="color:#ae81ff">0</span>], <span style="color:#e6db74">&#39;addr&#39;</span>: cmp[<span style="color:#ae81ff">1</span>], 
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;bytes_received&#39;</span>: cmp[<span style="color:#ae81ff">2</span>], <span style="color:#e6db74">&#39;bytes_sent&#39;</span>: cmp[<span style="color:#ae81ff">3</span>], 
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;connected_since&#39;</span>: cmp[<span style="color:#ae81ff">4</span>]
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>        <span style="color:#75715e"># Addresses</span>
</span></span><span style="display:flex;"><span>        fh<span style="color:#f92672">.</span>readline() <span style="color:#75715e">#Skip Addr header</span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">while</span> <span style="color:#66d9ef">True</span>:
</span></span><span style="display:flex;"><span>            cmp <span style="color:#f92672">=</span> fh<span style="color:#f92672">.</span>readline()<span style="color:#f92672">.</span>strip()<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;,&#39;</span>)
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> len(cmp) <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">4</span>:
</span></span><span style="display:flex;"><span>                <span style="color:#66d9ef">break</span>
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> cmp[<span style="color:#ae81ff">2</span>] <span style="color:#f92672">in</span> clients:
</span></span><span style="display:flex;"><span>                clients[cmp[<span style="color:#ae81ff">2</span>]] <span style="color:#f92672">=</span> {
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;name&#39;</span>: <span style="color:#e6db74">&#39;Unknown&#39;</span>, <span style="color:#e6db74">&#39;addr&#39;</span>: <span style="color:#e6db74">&#39;Unknown&#39;</span>, 
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;bytes_received&#39;</span>: <span style="color:#ae81ff">0</span>, <span style="color:#e6db74">&#39;bytes_sent&#39;</span>: <span style="color:#ae81ff">0</span>, 
</span></span><span style="display:flex;"><span>                    <span style="color:#e6db74">&#39;connected_since&#39;</span>: <span style="color:#e6db74">&#34;Unknown&#34;</span>
</span></span><span style="display:flex;"><span>                }
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> <span style="color:#f92672">not</span> <span style="color:#e6db74">&#39;virtual&#39;</span> <span style="color:#f92672">in</span> clients[cmp[<span style="color:#ae81ff">2</span>]]:
</span></span><span style="display:flex;"><span>                    clients[cmp[<span style="color:#ae81ff">2</span>]][<span style="color:#e6db74">&#39;virtual&#39;</span>] <span style="color:#f92672">=</span> []
</span></span><span style="display:flex;"><span>                    clients[cmp[<span style="color:#ae81ff">2</span>]][<span style="color:#e6db74">&#39;name&#39;</span>]    <span style="color:#f92672">=</span> cmp[<span style="color:#ae81ff">1</span>]
</span></span><span style="display:flex;"><span>            clients[cmp[<span style="color:#ae81ff">2</span>]][<span style="color:#e6db74">&#39;virtual&#39;</span>]<span style="color:#f92672">.</span>append(cmp[<span style="color:#ae81ff">0</span>])
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> jsonify({<span style="color:#e6db74">&#39;last_updated&#39;</span>: last_updated, <span style="color:#e6db74">&#39;clients&#39;</span>: list(clients<span style="color:#f92672">.</span>values())})
</span></span></code></pre></div><h4 id="adding-users">Adding users</h4>
<p>The other implemented feature is the ability to add new users to the vpn from the interface. To do this, there are two different ways: call the easy-rsa executable to create the certificate or create them directly in the API with another library. We went with the second option.</p>
<p>The function below creates a user certificate, signs it and put all the required files in a dedicated folder under <code>CLIENT_CONFIG_DIR</code>. This will be used later to generate the .ovpn file for the clients.
It then appends the client to the openvpn database to allow connection.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create_client</span>(C, ST, L, O, OU, CN, name, emailAddress, keySize<span style="color:#f92672">=</span><span style="color:#ae81ff">2048</span>, maxUsage<span style="color:#f92672">=</span>FIFTY_YEARS):
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>fine(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Creating client </span><span style="color:#e6db74">{</span>CN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 0. Check args and client existence</span>
</span></span><span style="display:flex;"><span>    DISSALOW_CN <span style="color:#f92672">=</span> [<span style="color:#e6db74">&#39; &#39;</span>, <span style="color:#e6db74">&#39;&amp;&#39;</span>, <span style="color:#e6db74">&#39;.&#39;</span>, <span style="color:#e6db74">&#39;/&#39;</span>, <span style="color:#e6db74">&#39;!&#39;</span>, <span style="color:#e6db74">&#39;:&#39;</span>, <span style="color:#e6db74">&#39;$&#39;</span>]
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> c <span style="color:#f92672">in</span> DISSALOW_CN:
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> c <span style="color:#f92672">in</span> CN:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> ServerException({<span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;&#34;&#39;</span> <span style="color:#f92672">+</span> c <span style="color:#f92672">+</span><span style="color:#e6db74">&#39;&#34; is not allowed in a CN&#39;</span>})
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">for</span> elem <span style="color:#f92672">in</span> (C, ST, L, O, OU, CN, name, emailAddress):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> elem <span style="color:#f92672">==</span> <span style="color:#66d9ef">None</span> <span style="color:#f92672">or</span> elem <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;&#39;</span>:
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">raise</span> ServerException({<span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">&#39;An argument is not set&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client_config_dir <span style="color:#f92672">=</span> join(CLIENT_CONFIG_DIR, CN)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> isdir(client_config_dir):
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">raise</span> ServerException({<span style="color:#e6db74">&#39;error&#39;</span>: <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;The client already exists, please ensure &#34;</span><span style="color:#e6db74">{</span>CN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34; is deleted&#39;</span>})
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># 1. Create client</span>
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>makedirs(client_config_dir, exist_ok<span style="color:#f92672">=</span><span style="color:#66d9ef">True</span>)
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Created client config dir </span><span style="color:#e6db74">{</span>client_config_dir<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create client Key pair</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>fine(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Creating a </span><span style="color:#e6db74">{</span>keySize<span style="color:#e6db74">}</span><span style="color:#e6db74"> bits keypair for </span><span style="color:#e6db74">{</span>CN<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    key_pair <span style="color:#f92672">=</span> EVP<span style="color:#f92672">.</span>RSA<span style="color:#f92672">.</span>gen_key(keySize, <span style="color:#ae81ff">65537</span>) <span style="color:#75715e"># e = 65537, padding is handled by openvpn</span>
</span></span><span style="display:flex;"><span>    key_pair<span style="color:#f92672">.</span>save_key(join(client_config_dir, CN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.key&#39;</span>), cipher<span style="color:#f92672">=</span><span style="color:#66d9ef">None</span>) <span style="color:#75715e"># save keypair</span>
</span></span><span style="display:flex;"><span>    client_public_key <span style="color:#f92672">=</span> EVP<span style="color:#f92672">.</span>PKey()
</span></span><span style="display:flex;"><span>    client_public_key<span style="color:#f92672">.</span>assign_rsa(key_pair)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># create client CSR from params</span>
</span></span><span style="display:flex;"><span>    client_cert_request <span style="color:#f92672">=</span> X509<span style="color:#f92672">.</span>X509_Name() <span style="color:#75715e"># X509.Request()</span>
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>C <span style="color:#f92672">=</span> C
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>ST <span style="color:#f92672">=</span> ST
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>L <span style="color:#f92672">=</span> L
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>O <span style="color:#f92672">=</span> O
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>OU <span style="color:#f92672">=</span> OU
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>CN <span style="color:#f92672">=</span> CN
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
</span></span><span style="display:flex;"><span>    client_cert_request<span style="color:#f92672">.</span>emailAddress <span style="color:#f92672">=</span> emailAddress
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Sign the client certificate with the Server CA</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>fine(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Loading server CA&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Load CA cert &amp; key</span>
</span></span><span style="display:flex;"><span>    ca_cert <span style="color:#f92672">=</span> X509<span style="color:#f92672">.</span>load_cert(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;ca.crt&#39;</span>))
</span></span><span style="display:flex;"><span>    ca_key  <span style="color:#f92672">=</span> EVP<span style="color:#f92672">.</span>RSA<span style="color:#f92672">.</span>load_key(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;ca.key&#39;</span>))
</span></span><span style="display:flex;"><span>    ca_sk   <span style="color:#f92672">=</span> EVP<span style="color:#f92672">.</span>PKey()
</span></span><span style="display:flex;"><span>    ca_sk<span style="color:#f92672">.</span>assign_rsa(ca_key)
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Create new certificate</span>
</span></span><span style="display:flex;"><span>    client_crt <span style="color:#f92672">=</span> X509<span style="color:#f92672">.</span>X509()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Set expiracy</span>
</span></span><span style="display:flex;"><span>    t <span style="color:#f92672">=</span> int(time<span style="color:#f92672">.</span>time()) <span style="color:#f92672">+</span> time<span style="color:#f92672">.</span>timezone
</span></span><span style="display:flex;"><span>    now <span style="color:#f92672">=</span> ASN1<span style="color:#f92672">.</span>ASN1_TIME()
</span></span><span style="display:flex;"><span>    expire <span style="color:#f92672">=</span> ASN1<span style="color:#f92672">.</span>ASN1_TIME()
</span></span><span style="display:flex;"><span>    now<span style="color:#f92672">.</span>set_time(t)
</span></span><span style="display:flex;"><span>    expire<span style="color:#f92672">.</span>set_time(t <span style="color:#f92672">+</span> maxUsage)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>set_not_before(now)
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>set_not_after(expire)
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>set_issuer(ca_cert<span style="color:#f92672">.</span>get_subject())
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>set_pubkey(client_public_key)
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>set_subject(client_cert_request) <span style="color:#75715e"># .get_subject()</span>
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>sign(ca_sk, <span style="color:#e6db74">&#39;sha1&#39;</span>) <span style="color:#75715e"># sign cert with CA key and SHA1 (we should update to SHA256)</span>
</span></span><span style="display:flex;"><span>    client_crt<span style="color:#f92672">.</span>save(join(client_config_dir, CN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.crt&#39;</span>)) <span style="color:#75715e"># Save cert</span>
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Signed </span><span style="color:#e6db74">{</span>CN<span style="color:#e6db74">}</span><span style="color:#e6db74"> certificate with server CA&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Setup directories</span>
</span></span><span style="display:flex;"><span>    shutil<span style="color:#f92672">.</span>copy(CLIENT_BASE_CONFIG, join(client_config_dir, CN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.conf&#39;</span>))
</span></span><span style="display:flex;"><span>    os<span style="color:#f92672">.</span>symlink(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;ca.crt&#39;</span>), join(client_config_dir, <span style="color:#e6db74">&#39;ca.crt&#39;</span>))
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>success(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Linked CA in client folder&#39;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">## Commit cert to database</span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;serial&#39;</span>), <span style="color:#e6db74">&#39;r&#39;</span>) <span style="color:#66d9ef">as</span> ser:
</span></span><span style="display:flex;"><span>        serial <span style="color:#f92672">=</span> ser<span style="color:#f92672">.</span>read()<span style="color:#f92672">.</span>strip()
</span></span><span style="display:flex;"><span>    log<span style="color:#f92672">.</span>fine(<span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;Client serial is </span><span style="color:#e6db74">{</span>serial<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;index.txt&#39;</span>), <span style="color:#e6db74">&#39;a+&#39;</span>) <span style="color:#66d9ef">as</span> db:
</span></span><span style="display:flex;"><span>        db<span style="color:#f92672">.</span>write(<span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\t</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join(
</span></span><span style="display:flex;"><span>            [
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;V&#39;</span>,
</span></span><span style="display:flex;"><span>                datetime<span style="color:#f92672">.</span>datetime<span style="color:#f92672">.</span>fromtimestamp(t <span style="color:#f92672">+</span> maxUsage)<span style="color:#f92672">.</span>strftime(<span style="color:#e6db74">&#34;%y%m</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">%H%m%SZ&#34;</span>),
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{</span>serial<span style="color:#e6db74">}</span><span style="color:#e6db74">&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">&#39;unknown&#39;</span>,
</span></span><span style="display:flex;"><span>                <span style="color:#e6db74">f</span><span style="color:#e6db74">&#39;/C=</span><span style="color:#e6db74">{</span>C<span style="color:#e6db74">}</span><span style="color:#e6db74">/ST=</span><span style="color:#e6db74">{</span>ST<span style="color:#e6db74">}</span><span style="color:#e6db74">/L=</span><span style="color:#e6db74">{</span>L<span style="color:#e6db74">}</span><span style="color:#e6db74">/O=</span><span style="color:#e6db74">{</span>O<span style="color:#e6db74">}</span><span style="color:#e6db74">/OU=</span><span style="color:#e6db74">{</span>OU<span style="color:#e6db74">}</span><span style="color:#e6db74">/CN=</span><span style="color:#e6db74">{</span>CN<span style="color:#e6db74">}</span><span style="color:#e6db74">/name=</span><span style="color:#e6db74">{</span>name<span style="color:#e6db74">}</span><span style="color:#e6db74">/emailAddress=</span><span style="color:#e6db74">{</span>emailAddress<span style="color:#e6db74">}</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>
</span></span><span style="display:flex;"><span>            ]
</span></span><span style="display:flex;"><span>        ))
</span></span><span style="display:flex;"><span>    shutil<span style="color:#f92672">.</span>copy(join(client_config_dir, CN <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.crt&#39;</span>), join(SERVER_CONFIG_KEY_DIR, serial <span style="color:#f92672">+</span> <span style="color:#e6db74">&#39;.crt&#39;</span>))
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Increment serial number</span>
</span></span><span style="display:flex;"><span>    serial <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;</span><span style="color:#e6db74">{0:x}</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>format(int(serial, base<span style="color:#f92672">=</span><span style="color:#ae81ff">16</span>) <span style="color:#f92672">+</span> <span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>capitalize()<span style="color:#f92672">.</span>zfill(<span style="color:#ae81ff">2</span>)
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">with</span> open(join(SERVER_CONFIG_KEY_DIR, <span style="color:#e6db74">&#39;serial&#39;</span>), <span style="color:#e6db74">&#39;w&#39;</span>) <span style="color:#66d9ef">as</span> ser:
</span></span><span style="display:flex;"><span>        ser<span style="color:#f92672">.</span>write(serial)
</span></span></code></pre></div><p>The backbone of the API consists of these two functions and are tied to the API, because they don&rsquo;t required additional threads and use the filesystem to operate, they are very straightforward to use in the API safely.</p>
<h3 id="api-outline">API Outline</h3>
<p>The API only has a few routes,</p>
<ul>
<li><code>/status</code> to pull VPN information</li>
<li><code>/client/&lt;name&gt;/config</code> to get a client .ovpn config, the configuration is built on the fly by appening the different generated files in the supported OpenVPN format</li>
<li><code>/download/&lt;token&gt;</code> using a generated token so a person can download their configuration</li>
<li><code>/client/auto_find_config</code> uses the JWT payload from the lab website to extract the common name and create an account automatically.</li>
</ul>
<p>Should I rewrite this software, I&rsquo;d opt for FastAPI to get the API documentation.</p>
<h1 id="front-end">Front-end</h1>
<p>Front end was made using vuejs and was a test case usage. The vuejs documentation is enough to get started and use an existing API. Further work include a better UI.</p>

    <h4><a href="https://win32.gg">Back to Home</a></h4>
</div>


        </div><footer class="container">
    <hr class="soften">
    <p>
        &copy; 
        <a href="http://win32.gg" target="_blank">
            WIN32GG
        </a>
        <span id="thisyear">2022</span>
        
    </p>
    <p class="text-center">
        
        
        <a href="https://www.linkedin.com/in/gjouet/">Linkedin</a> 
        <a href="https://github.com/WIN32GG">GitHub</a> 
        
    </p>
</footer>

<script src="/js/jquery.js"></script>
<script src="/js/bootstrap-386.js"></script>
<script src="/js/bootstrap-transition.js"></script>
<script src="/js/bootstrap-alert.js"></script>
<script src="/js/bootstrap-modal.js"></script>
<script src="/js/bootstrap-dropdown.js"></script>
<script src="/js/bootstrap-scrollspy.js"></script>
<script src="/js/bootstrap-tab.js"></script>
<script src="/js/bootstrap-tooltip.js"></script>
<script src="/js/bootstrap-popover.js"></script>
<script src="/js/bootstrap-button.js"></script>
<script src="/js/bootstrap-collapse.js"></script>
<script src="/js/bootstrap-carousel.js"></script>
<script src="/js/bootstrap-typeahead.js"></script>
<script src="/js/bootstrap-affix.js"></script>
<script>
    _386 = { 
        fastLoad: true ,
        onePass: true , 
        speedFactor: 1 
    };

    
    function ThisYear() {
        document.getElementById('thisyear').innerHTML = new Date().getFullYear();
    };
</script></body>
</html>
